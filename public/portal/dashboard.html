<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | Customer Portal | Homestead Cabinet Design</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <header class="portal-header">
    <a href="/portal/dashboard.html" class="portal-logo">
      <svg width="32" height="32" viewBox="0 0 24 24" fill="var(--color-accent)">
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H5v-2h7v2zm7-4H5v-2h14v2zm0-4H5V7h14v2z"/>
      </svg>
      Homestead Cabinet Design
    </a>
    <nav class="portal-nav">
      <a href="/portal/dashboard.html" class="portal-nav-link active">Dashboard</a>
      <a href="/portal/quotes.html" class="portal-nav-link">Quotes</a>
      <a href="/portal/invoices.html" class="portal-nav-link">Invoices</a>
      <a href="/portal/files.html" class="portal-nav-link">Files</a>
      <a href="/portal/uploads.html" class="portal-nav-link">Uploads</a>
    </nav>
  </header>
  
  <main class="portal-container">
    <!-- Welcome Section -->
    <div class="mb-xl">
      <h1 id="welcome-message">Welcome back</h1>
      <p class="text-muted">Here's an overview of your projects with Homestead Cabinet Design.</p>
    </div>
    
    <!-- Balance & Payment Section -->
    <div class="grid grid-cols-2 gap-lg mb-xl" id="stats-section">
      <div class="stat-card">
        <div class="stat-card-label">Current Balance Due</div>
        <div class="stat-card-value" id="balance-due">$0.00</div>
        <div id="next-due-date" class="text-sm text-muted mt-sm"></div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">Total Paid</div>
        <div class="stat-card-value" id="total-paid">$0.00</div>
        <div class="text-sm text-muted mt-sm">Lifetime payments</div>
      </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="card mb-xl" id="action-section" style="display: none;">
      <div class="card-body">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="mb-sm" id="action-title">You have a pending quote</h3>
            <p class="text-muted mb-0" id="action-description">Review and accept to get started.</p>
          </div>
          <a href="#" class="btn btn-primary" id="action-button">View Quote</a>
        </div>
      </div>
    </div>
    
    <!-- Make Payment Section -->
    <div class="card mb-xl" id="payment-section" style="display: none;">
      <div class="card-header">
        <h3 class="card-title">Make a Payment</h3>
      </div>
      <div class="card-body">
        <div class="flex items-center justify-between">
          <div>
            <p class="mb-sm">Balance due: <strong id="payment-balance">$0.00</strong></p>
            <p class="text-muted mb-0" id="payment-invoice-info"></p>
          </div>
          <button class="btn btn-accent" id="make-payment-btn">Pay Now</button>
        </div>
      </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="card mb-xl">
      <div class="card-header">
        <h3 class="card-title">Recent Activity</h3>
      </div>
      <div class="card-body" id="activity-list">
        <div class="skeleton" style="height: 60px; margin-bottom: 12px;"></div>
        <div class="skeleton" style="height: 60px; margin-bottom: 12px;"></div>
        <div class="skeleton" style="height: 60px;"></div>
      </div>
    </div>
    
    <!-- Quick Links -->
    <div class="grid grid-cols-3 gap-lg">
      <a href="/portal/uploads.html" class="card" style="text-decoration: none;">
        <div class="card-body text-center">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--color-primary)" stroke-width="2" style="margin: 0 auto var(--space-sm);">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
          </svg>
          <h4 style="margin-bottom: var(--space-xs);">Upload Photos</h4>
          <p class="text-muted text-sm mb-0">Share inspiration images</p>
        </div>
      </a>
      
      <a href="/portal/quotes.html" class="card" style="text-decoration: none;">
        <div class="card-body text-center">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--color-primary)" stroke-width="2" style="margin: 0 auto var(--space-sm);">
            <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
            <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
          </svg>
          <h4 style="margin-bottom: var(--space-xs);">View Quotes</h4>
          <p class="text-muted text-sm mb-0">Review your estimates</p>
        </div>
      </a>
      
      <a href="/portal/files.html" class="card" style="text-decoration: none;">
        <div class="card-body text-center">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--color-primary)" stroke-width="2" style="margin: 0 auto var(--space-sm);">
            <path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/>
          </svg>
          <h4 style="margin-bottom: var(--space-xs);">Project Files</h4>
          <p class="text-muted text-sm mb-0">Documents & attachments</p>
        </div>
      </a>
    </div>
  </main>
  
  <script src="/js/utils.js"></script>
  <script src="/js/portal-auth.js"></script>
  <script>
    
    let customer = null;
    
    async function loadDashboard() {
      try {
        // Get customer data
        const response = await apiCall('portal-data');
        customer = response.customer;
        
        // Update welcome message
        $('#welcome-message').textContent = `Welcome back, ${customer.name.split(' ')[0]}`;
        
        // Calculate totals
        const balanceDue = response.invoices
          .filter(inv => inv.status !== 'paid' && inv.status !== 'cancelled')
          .reduce((sum, inv) => sum + parseFloat(inv.amount_due || 0), 0);
        
        const totalPaid = response.payments
          .filter(p => p.status === 'succeeded')
          .reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
        
        $('#balance-due').textContent = formatCurrency(balanceDue);
        $('#total-paid').textContent = formatCurrency(totalPaid);
        
        // Find next due date
        const unpaidInvoices = response.invoices
          .filter(inv => inv.status !== 'paid' && inv.status !== 'cancelled' && inv.due_date)
          .sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
        
        if (unpaidInvoices.length > 0) {
          const nextDue = unpaidInvoices[0];
          $('#next-due-date').textContent = `Next payment due: ${formatDate(nextDue.due_date)}`;
        }
        
        // Show payment section if balance due
        if (balanceDue > 0) {
          $('#payment-section').style.display = 'block';
          $('#payment-balance').textContent = formatCurrency(balanceDue);
          if (unpaidInvoices.length > 0) {
            $('#payment-invoice-info').textContent = `Invoice #${unpaidInvoices[0].invoice_number}`;
          }
        }
        
        // Check for pending quotes
        const pendingQuotes = response.quotes.filter(q => q.status === 'sent' || q.status === 'viewed');
        if (pendingQuotes.length > 0) {
          const latestQuote = pendingQuotes[0];
          $('#action-section').style.display = 'block';
          $('#action-title').textContent = `You have a quote ready for review`;
          $('#action-description').textContent = `${latestQuote.title} - ${formatCurrency(latestQuote.total)}`;
          $('#action-button').href = `/portal/quote.html?id=${latestQuote.id}`;
        }
        
        // Build activity list
        buildActivityList(response);
        
      } catch (err) {
        console.error('Failed to load dashboard:', err);
        showToast('Failed to load dashboard data', 'error');
      }
    }
    
    function buildActivityList(data) {
      const activities = [];
      
      // Add quotes
      data.quotes.forEach(quote => {
        activities.push({
          type: 'quote',
          title: `Quote: ${quote.title}`,
          subtitle: formatCurrency(quote.total),
          status: quote.status,
          date: quote.updated_at || quote.created_at,
          link: `/portal/quote.html?id=${quote.id}`
        });
      });
      
      // Add invoices
      data.invoices.forEach(invoice => {
        activities.push({
          type: 'invoice',
          title: `Invoice #${invoice.invoice_number}`,
          subtitle: `${formatCurrency(invoice.amount_due)} due`,
          status: invoice.status,
          date: invoice.updated_at || invoice.created_at,
          link: `/portal/invoice.html?id=${invoice.id}`
        });
      });
      
      // Add payments
      data.payments.forEach(payment => {
        activities.push({
          type: 'payment',
          title: `Payment received`,
          subtitle: formatCurrency(payment.amount),
          status: 'paid',
          date: payment.payment_date,
          link: null
        });
      });
      
      // Sort by date
      activities.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      // Render
      const container = $('#activity-list');
      clearElement(container);
      
      if (activities.length === 0) {
        container.innerHTML = '<p class="text-muted text-center p-lg">No recent activity</p>';
        return;
      }
      
      activities.slice(0, 10).forEach(activity => {
        const icon = getActivityIcon(activity.type);
        const item = createElement('div', { 
          className: 'flex items-center gap-md p-md',
          style: 'border-bottom: 1px solid var(--color-border-light);'
        }, [
          createElement('div', { 
            innerHTML: icon,
            style: 'width: 40px; height: 40px; background: var(--color-bg-alt); border-radius: 50%; display: flex; align-items: center; justify-content: center;'
          }),
          createElement('div', { className: 'flex-1' }, [
            createElement('div', { className: 'font-bold', textContent: activity.title }),
            createElement('div', { className: 'text-sm text-muted', textContent: activity.subtitle })
          ]),
          createElement('div', { className: 'text-right' }, [
            createElement('span', { className: `badge badge-${activity.status}`, textContent: activity.status }),
            createElement('div', { className: 'text-sm text-muted mt-xs', textContent: formatRelativeTime(activity.date) })
          ])
        ]);
        
        if (activity.link) {
          item.style.cursor = 'pointer';
          item.addEventListener('click', () => window.location.href = activity.link);
        }
        
        container.appendChild(item);
      });
    }
    
    function getActivityIcon(type) {
      const icons = {
        quote: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>',
        invoice: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
        payment: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>'
      };
      return icons[type] || '';
    }
    
    // Make payment button
    $('#make-payment-btn').addEventListener('click', () => {
      window.location.href = '/portal/invoices.html';
    });
    
    // Initialize
    loadDashboard();
  </script>
</body>
</html>
