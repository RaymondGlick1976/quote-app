<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoices | Admin | Homestead Cabinet Design</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div class="app-layout">
    <aside class="app-sidebar">
      <div class="sidebar-logo">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="var(--color-accent)">
          <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H5v-2h7v2zm7-4H5v-2h14v2zm0-4H5V7h14v2z"/>
        </svg>
        Homestead
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item"><a href="/admin/index.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Dashboard</a></li>
          <li class="sidebar-nav-item"><a href="/admin/customers.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Customers</a></li>
          <li class="sidebar-nav-item"><a href="/admin/quotes.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>Quotes</a></li>
          <li class="sidebar-nav-item"><a href="/admin/invoices.html" class="sidebar-nav-link active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg>Invoices</a></li>
        </ul>
      </nav>
    </aside>
    
    <main class="app-main">
      <header class="app-header">
        <h2>Invoices</h2>
      </header>
      
      <div class="app-content">
        <!-- Filters -->
        <div class="card mb-xl">
          <div class="card-body">
            <div class="flex gap-md items-center">
              <input type="text" id="search-input" class="form-input" placeholder="Search invoices..." style="max-width: 300px;">
              <select id="status-filter" class="form-select" style="max-width: 150px;">
                <option value="">All Status</option>
                <option value="draft">Draft</option>
                <option value="sent">Sent</option>
                <option value="viewed">Viewed</option>
                <option value="partial">Partial</option>
                <option value="paid">Paid</option>
                <option value="overdue">Overdue</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Invoices Table -->
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Invoice #</th>
                  <th>Customer</th>
                  <th>Title</th>
                  <th>Total</th>
                  <th>Paid</th>
                  <th>Due</th>
                  <th>Status</th>
                  <th>Due Date</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="invoices-tbody">
                <tr>
                  <td colspan="9" style="text-align: center; padding: 40px;">
                    <div class="loading-spinner" style="margin: 0 auto;"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script src="/js/utils.js"></script>
  <script>
    
    let invoices = [];
    
    async function loadInvoices() {
      try {
        const supabase = await app.waitForSupabase();
        
        const { data, error } = await supabase
          .from('invoices')
          .select('*, customers(name, email)')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        invoices = data || [];
        renderInvoices(invoices);
      } catch (err) {
        console.error('Load error:', err);
        showToast('Failed to load invoices', 'error');
      }
    }
    
    function renderInvoices(data) {
      const tbody = $('#invoices-tbody');
      clearElement(tbody);
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted p-xl">No invoices found</td></tr>';
        return;
      }
      
      data.forEach(invoice => {
        const row = createElement('tr');
        row.innerHTML = `
          <td><strong>${invoice.invoice_number}</strong></td>
          <td>
            <div>${invoice.customers?.name || '—'}</div>
            <div class="text-sm text-muted">${invoice.customers?.email || ''}</div>
          </td>
          <td>${invoice.title}</td>
          <td>${formatCurrency(invoice.total)}</td>
          <td>${formatCurrency(invoice.amount_paid)}</td>
          <td class="${invoice.amount_due > 0 ? 'text-danger font-bold' : ''}">${formatCurrency(invoice.amount_due)}</td>
          <td><span class="badge badge-${invoice.status}">${invoice.status}</span></td>
          <td>${invoice.due_date ? formatDate(invoice.due_date) : '—'}</td>
          <td class="table-actions">
            <button class="btn btn-ghost btn-sm" onclick="viewInvoice('${invoice.id}')">View</button>
            ${invoice.status === 'draft' ? `<button class="btn btn-ghost btn-sm" onclick="sendInvoice('${invoice.id}')">Send</button>` : ''}
            ${invoice.amount_due > 0 ? `<button class="btn btn-ghost btn-sm" onclick="recordPayment('${invoice.id}')">Record Payment</button>` : ''}
          </td>
        `;
        tbody.appendChild(row);
      });
    }
    
    // Search & Filter
    const searchInput = $('#search-input');
    const statusFilter = $('#status-filter');
    
    function applyFilters() {
      const query = searchInput.value.toLowerCase();
      const status = statusFilter.value;
      
      let filtered = invoices;
      
      if (query) {
        filtered = filtered.filter(inv => 
          inv.invoice_number.toLowerCase().includes(query) ||
          inv.title.toLowerCase().includes(query) ||
          inv.customers?.name?.toLowerCase().includes(query) ||
          inv.customers?.email?.toLowerCase().includes(query)
        );
      }
      
      if (status) {
        filtered = filtered.filter(inv => inv.status === status);
      }
      
      renderInvoices(filtered);
    }
    
    searchInput.addEventListener('input', debounce(applyFilters, 300));
    statusFilter.addEventListener('change', applyFilters);
    
    window.viewInvoice = async (id) => {
      const invoice = invoices.find(i => i.id === id);
      if (!invoice) return;
      
      // Load line items
      const supabase = await app.waitForSupabase();
      const { data: lineItems } = await supabase
        .from('invoice_line_items')
        .select('*')
        .eq('invoice_id', id)
        .order('sort_order');
      
      const { data: payments } = await supabase
        .from('payments')
        .select('*')
        .eq('invoice_id', id)
        .eq('status', 'succeeded')
        .order('payment_date', { ascending: false });
      
      let itemsHtml = '';
      if (lineItems && lineItems.length > 0) {
        itemsHtml = `
          <table class="table" style="margin-bottom: var(--space-lg);">
            <thead>
              <tr>
                <th>Description</th>
                <th style="text-align: right;">Qty</th>
                <th style="text-align: right;">Price</th>
                <th style="text-align: right;">Total</th>
              </tr>
            </thead>
            <tbody>
              ${lineItems.map(item => `
                <tr>
                  <td>
                    <div>${item.description}</div>
                    ${item.details ? `<div class="text-sm text-muted">${item.details}</div>` : ''}
                  </td>
                  <td style="text-align: right;">${item.quantity}</td>
                  <td style="text-align: right;">${formatCurrency(item.unit_price)}</td>
                  <td style="text-align: right;">${formatCurrency(item.line_total)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }
      
      let paymentsHtml = '';
      if (payments && payments.length > 0) {
        paymentsHtml = `
          <div style="margin-top: var(--space-lg); padding-top: var(--space-lg); border-top: 1px solid var(--color-border);">
            <h4 style="margin-bottom: var(--space-sm);">Payment History</h4>
            ${payments.map(p => `
              <div class="flex justify-between items-center" style="padding: var(--space-sm) 0; border-bottom: 1px solid var(--color-border-light);">
                <div>
                  <div>${formatCurrency(p.amount)}</div>
                  <div class="text-sm text-muted">${formatDate(p.payment_date)} • ${p.payment_method || 'Card'}</div>
                </div>
                <span class="badge badge-paid">Paid</span>
              </div>
            `).join('')}
          </div>
        `;
      }
      
      const content = `
        <div class="flex justify-between mb-lg">
          <div>
            <div class="text-sm text-muted">Customer</div>
            <div class="font-bold">${invoice.customers?.name || '—'}</div>
            <div class="text-sm">${invoice.customers?.email || ''}</div>
          </div>
          <div style="text-align: right;">
            <div class="text-sm text-muted">Due Date</div>
            <div class="font-bold">${invoice.due_date ? formatDate(invoice.due_date) : '—'}</div>
          </div>
        </div>
        
        ${itemsHtml}
        
        <div style="background: var(--color-bg-soft); padding: var(--space-md); border-radius: var(--radius-md);">
          <div class="flex justify-between mb-sm">
            <span>Subtotal</span>
            <span>${formatCurrency(invoice.subtotal)}</span>
          </div>
          ${invoice.tax_amount > 0 ? `
            <div class="flex justify-between mb-sm">
              <span>Tax (${(invoice.tax_rate * 100).toFixed(2)}%)</span>
              <span>${formatCurrency(invoice.tax_amount)}</span>
            </div>
          ` : ''}
          <div class="flex justify-between font-bold" style="padding-top: var(--space-sm); border-top: 1px solid var(--color-border);">
            <span>Total</span>
            <span>${formatCurrency(invoice.total)}</span>
          </div>
          <div class="flex justify-between mt-sm text-success">
            <span>Paid</span>
            <span>${formatCurrency(invoice.amount_paid)}</span>
          </div>
          <div class="flex justify-between mt-sm font-bold" style="color: ${invoice.amount_due > 0 ? 'var(--color-danger)' : 'var(--color-success)'};">
            <span>Balance Due</span>
            <span>${formatCurrency(invoice.amount_due)}</span>
          </div>
        </div>
        
        ${paymentsHtml}
      `;
      
      const footer = createElement('div', { className: 'btn-group' });
      const closeBtn = createElement('button', {
        className: 'btn btn-secondary',
        textContent: 'Close'
      });
      footer.appendChild(closeBtn);
      
      if (invoice.amount_due > 0) {
        const payBtn = createElement('button', {
          className: 'btn btn-primary',
          textContent: 'Record Payment'
        });
        payBtn.addEventListener('click', () => {
          closeModal(modal);
          recordPayment(id);
        });
        footer.appendChild(payBtn);
      }
      
      const modal = createModal({
        title: `Invoice ${invoice.invoice_number}`,
        content: content,
        footer: footer,
        size: 'lg'
      });
      
      closeBtn.addEventListener('click', () => closeModal(modal));
    };
    
    window.sendInvoice = async (id) => {
      if (!await confirm('Send this invoice to the customer?')) return;
      
      try {
        // Call email function
        const response = await fetch('/.netlify/functions/send-invoice-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ invoiceId: id })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to send email');
        }
        
        showToast('Invoice sent to customer!', 'success');
        loadInvoices();
      } catch (err) {
        console.error('Send error:', err);
        showToast('Failed to send: ' + err.message, 'error');
      }
    };
    
    window.recordPayment = (id) => {
      const invoice = invoices.find(i => i.id === id);
      if (!invoice) return;
      
      const content = createElement('form', { id: 'payment-form' });
      content.innerHTML = `
        <div class="form-group">
          <label class="form-label">Payment Amount *</label>
          <input type="number" name="amount" class="form-input" value="${invoice.amount_due}" step="0.01" min="0.01" max="${invoice.amount_due}" required>
          <div class="text-sm text-muted mt-xs">Amount due: ${formatCurrency(invoice.amount_due)}</div>
        </div>
        <div class="form-group">
          <label class="form-label">Payment Method *</label>
          <select name="payment_method" class="form-select" required>
            <option value="cash">Cash</option>
            <option value="check">Check</option>
            <option value="card">Credit/Debit Card</option>
            <option value="bank_transfer">Bank Transfer</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Reference # (optional)</label>
          <input type="text" name="reference" class="form-input" placeholder="Check number, transaction ID, etc.">
        </div>
        <div class="form-group">
          <label class="form-label">Payment Date</label>
          <input type="date" name="payment_date" class="form-input" value="${new Date().toISOString().split('T')[0]}">
        </div>
        <div class="form-group">
          <label class="form-label">Notes (optional)</label>
          <textarea name="notes" class="form-textarea" rows="2"></textarea>
        </div>
      `;
      
      const footer = createElement('div', { className: 'btn-group' });
      const cancelBtn = createElement('button', {
        type: 'button',
        className: 'btn btn-secondary',
        textContent: 'Cancel'
      });
      const saveBtn = createElement('button', {
        type: 'submit',
        className: 'btn btn-primary',
        textContent: 'Record Payment'
      });
      footer.appendChild(cancelBtn);
      footer.appendChild(saveBtn);
      
      const modal = createModal({
        title: `Record Payment - ${invoice.invoice_number}`,
        content: content,
        footer: footer
      });
      
      cancelBtn.addEventListener('click', () => closeModal(modal));
      
      content.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (content.checkValidity()) {
          const formData = new FormData(content);
          await savePayment(id, formData);
          closeModal(modal);
        } else {
          content.reportValidity();
        }
      });
    };
    
    async function savePayment(invoiceId, formData) {
      try {
        const supabase = await app.waitForSupabase();
        const invoice = invoices.find(i => i.id === invoiceId);
        
        const amount = parseFloat(formData.get('amount'));
        
        // Insert payment record
        const { error: paymentError } = await supabase
          .from('payments')
          .insert({
            invoice_id: invoiceId,
            customer_id: invoice.customer_id,
            amount: amount,
            payment_method: formData.get('payment_method'),
            reference_number: formData.get('reference') || null,
            payment_date: formData.get('payment_date'),
            notes: formData.get('notes') || null,
            status: 'succeeded'
          });
        
        if (paymentError) throw paymentError;
        
        // Update invoice amounts
        const newAmountPaid = parseFloat(invoice.amount_paid || 0) + amount;
        const newAmountDue = parseFloat(invoice.total) - newAmountPaid;
        const newStatus = newAmountDue <= 0 ? 'paid' : 'partial';
        
        const { error: invoiceError } = await supabase
          .from('invoices')
          .update({
            amount_paid: newAmountPaid,
            amount_due: Math.max(0, newAmountDue),
            status: newStatus
          })
          .eq('id', invoiceId);
        
        if (invoiceError) throw invoiceError;
        
        showToast('Payment recorded successfully!', 'success');
        loadInvoices();
      } catch (err) {
        console.error('Payment error:', err);
        showToast('Failed to record payment: ' + err.message, 'error');
      }
    }
    
    // Initialize
    loadInvoices();
  </script>
</body>
</html>
